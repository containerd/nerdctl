name: " "

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:

jobs:
  # Source the common environment
  environment:
    name: "project checks"
    uses: ./.github/workflows/reusable_environment.yml

  project:
    name: "project checks"
    timeout-minutes: ${{ fromJSON(needs.environment.outputs.SHORT_TIMEOUT) }}
    runs-on: ${{ needs.environment.outputs.HOST_UBUNTU_LTS }}
    needs: environment

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
        with:
          path: src/github.com/containerd/nerdctl
          # Fetch the last 100 commits
          fetch-depth: 100

      - name: "Install go"
        uses: actions/setup-go@v5
        with:
          go-version: ${{ needs.environment.outputs.GO_VERSION }}
          cache-dependency-path: src/github.com/containerd/nerdctl

      - name: "Install and run default containerd project checks"
        uses: containerd/project-checks@v1.1.0
        with:
          working-directory: src/github.com/containerd/nerdctl

      - name: "Verify no patent"
        run: ./hack/verify-no-patent.sh
        working-directory: src/github.com/containerd/nerdctl

      - name: "Verify package isolation"
        run: ./hack/verify-pkg-isolation.sh
        working-directory: src/github.com/containerd/nerdctl
