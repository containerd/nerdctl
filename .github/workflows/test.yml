name: test

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:
    paths-ignore:
      - '**.md'

env:
  GO_VERSION: 1.23.x
  SHORT_TIMEOUT: 5
  LONG_TIMEOUT: 60

jobs:
  test-integration-docker-compatibility:
    timeout-minutes: 60
    name: docker
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 1
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          check-latest: true
      - name: "Print docker info"
        run: |
          set -eux -o pipefail
          docker info
          docker version
      - name: "Register QEMU (tonistiigi/binfmt)"
        run: |
          # `--install all` will only install emulation for architectures that cannot be natively executed
          # Since some arm64 platforms do provide native fallback execution for 32 bits,
          # armv7 emulation may or may not be installed, causing variance in the result of `uname -m`.
          # To avoid that, we explicitly list the architectures we do want emulation for.
          docker run --privileged --rm tonistiigi/binfmt --install linux/amd64
          docker run --privileged --rm tonistiigi/binfmt --install linux/arm64
          docker run --privileged --rm tonistiigi/binfmt --install linux/arm/v7
      - name: "Prepare integration test environment"
        run: |
          sudo apt-get install -y expect
          go install -v gotest.tools/gotestsum@v1
      - name: "Ensure that the integration test suite is compatible with Docker"
        run: |
          # WITH_SUDO=true ./hack/test-integration.sh -test.target=docker
          # gotestsum --format=testname --jsonfile /tmp/test-integration.log --packages=/home/runner/work/nerdctl/nerdctl/hack/../cmd/nerdctl/... -- -timeout=60m -p 1 -exec sudo -args -test.allow-kill-daemon -test.target=docker
          go test ./cmd/nerdctl/builder/ ./cmd/nerdctl/container/ -exec sudo -p 1 -args -test.target=docker
